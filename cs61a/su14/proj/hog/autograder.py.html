<html>
<head>
<title>autograder.py</title>
<link href="css/assignments.css" rel="stylesheet" type="text/css">
</head>

<body>
<h3>autograder.py (<a href="autograder.py">plain text</a>)</h3>
<hr>
<pre>
<span style="color: darkred">"""
Student autograder utilities.

This file provides a common interface for the CS 61A project
student-side autograder. Students do not need to read or understand
the contents of this file.
"""

</span><span style="color: blue; font-weight: bold">import </span>argparse
<span style="color: blue; font-weight: bold">import </span>hmac
<span style="color: blue; font-weight: bold">import </span>os
<span style="color: blue; font-weight: bold">import </span>pdb
<span style="color: blue; font-weight: bold">import </span>pickle
<span style="color: blue; font-weight: bold">import </span>random
<span style="color: blue; font-weight: bold">import </span>re
<span style="color: blue; font-weight: bold">import </span>sys
<span style="color: blue; font-weight: bold">import </span>traceback
<span style="color: blue; font-weight: bold">import </span>urllib<span style="font-weight: bold">.</span>request
<span style="color: blue; font-weight: bold">from </span>code <span style="color: blue; font-weight: bold">import </span>InteractiveConsole<span style="font-weight: bold">, </span>compile_command
<span style="color: blue; font-weight: bold">from </span>threading <span style="color: blue; font-weight: bold">import </span>Thread

<span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
    </span><span style="color: blue; font-weight: bold">import </span>readline
    READLINE_FLAG <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">True
except </span>ImportError<span style="font-weight: bold">:
    </span>READLINE_FLAG <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">False

</span><span style="color: green; font-style: italic">######################
# PRINTING UTILITIES #
######################

</span><span style="color: blue; font-weight: bold">class </span>OutputLogger<span style="font-weight: bold">:
    </span><span style="color: darkred">"""Custom logger for capturing and suppressing standard output."""

    </span><span style="color: blue; font-weight: bold">def </span>__init__<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_current_stream <span style="font-weight: bold">= </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_stdout <span style="font-weight: bold">= </span>sys<span style="font-weight: bold">.</span>stdout
        <span style="color: blue">self</span><span style="font-weight: bold">.</span>_devnull <span style="font-weight: bold">= </span>open<span style="font-weight: bold">(</span>os<span style="font-weight: bold">.</span>devnull<span style="font-weight: bold">, </span><span style="color: red">'w'</span><span style="font-weight: bold">)
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_log <span style="font-weight: bold">= </span><span style="color: blue">None

    </span><span style="color: blue; font-weight: bold">def </span>on<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: darkred">"""Allows print statements to emit to standard output."""
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_current_stream <span style="font-weight: bold">= </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_stdout

    <span style="color: blue; font-weight: bold">def </span>off<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: darkred">"""Prevents print statements from emitting to standard out."""
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_current_stream <span style="font-weight: bold">= </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_devnull

    <span style="color: blue; font-weight: bold">def </span>register_log<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">, </span>log<span style="font-weight: bold">):
        </span><span style="color: darkred">"""Registers the given log so that all calls to write will
        append to the log.

        PARAMETERS:
        log -- list or None; if list, write will append all output to
               log. If None, output is not logged.
        """
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_log <span style="font-weight: bold">= </span>log

    @property
    <span style="color: blue; font-weight: bold">def </span>log<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: blue; font-weight: bold">return </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_log

    <span style="color: blue; font-weight: bold">def </span>write<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">, </span>msg<span style="font-weight: bold">):
        </span><span style="color: darkred">"""Writes msg to the current output stream (either standard
        out or dev/null). If a log has been registered, append msg
        to the log.

        PARAMTERS:
        msg -- str
        """
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_current_stream<span style="font-weight: bold">.</span>write<span style="font-weight: bold">(</span>msg<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_log<span style="font-weight: bold">) == </span>list<span style="font-weight: bold">:
            </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_log<span style="font-weight: bold">.</span>append<span style="font-weight: bold">(</span>msg<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">def </span>flush<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>_current_stream<span style="font-weight: bold">.</span>flush<span style="font-weight: bold">()

</span>logger <span style="font-weight: bold">= </span>sys<span style="font-weight: bold">.</span>stdout <span style="font-weight: bold">= </span>OutputLogger<span style="font-weight: bold">()

</span><span style="color: blue; font-weight: bold">def </span>split<span style="font-weight: bold">(</span>src<span style="font-weight: bold">, </span>join_str<span style="font-weight: bold">=</span><span style="color: blue">None</span><span style="font-weight: bold">):
    </span><span style="color: darkred">"""Splits a (possibly multiline) string of Python input into
    a list, adjusting for common indents based on the first line.

    PARAMETERS:
    src      -- str; (possibly) multiline string of Python input
    join_str -- str or None; if None, leave src as a list of strings.
                If not None, concatenate into one string, using "join"
                as the joining string

    DESCRIPTION:
    Indentation adjustment is determined by the first nonempty
    line. The characters of indentation for that line will be
    removed from the front of each subsequent line.

    RETURNS:
    list of strings; lines of Python input
    str; all lines combined into one string if join is not None
    """
    </span><span style="color: blue; font-weight: bold">if not </span>src<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">return </span><span style="font-weight: bold">[] </span><span style="color: blue; font-weight: bold">if not </span>join_str <span style="color: blue; font-weight: bold">else </span><span style="color: red">''
    </span>src <span style="font-weight: bold">= </span>src<span style="font-weight: bold">.</span>lstrip<span style="font-weight: bold">(</span><span style="color: red">'\n'</span><span style="font-weight: bold">).</span>rstrip<span style="font-weight: bold">()
    </span>match <span style="font-weight: bold">= </span>re<span style="font-weight: bold">.</span>match<span style="font-weight: bold">(</span><span style="color: red">'\s+'</span><span style="font-weight: bold">, </span>src<span style="font-weight: bold">)
    </span>length <span style="font-weight: bold">= </span>len<span style="font-weight: bold">(</span>match<span style="font-weight: bold">.</span>group<span style="font-weight: bold">(</span><span style="color: red">0</span><span style="font-weight: bold">)) </span><span style="color: blue; font-weight: bold">if </span>match <span style="color: blue; font-weight: bold">else </span><span style="color: red">0
    </span>result <span style="font-weight: bold">= [</span>line<span style="font-weight: bold">[</span>length<span style="font-weight: bold">:] </span><span style="color: blue; font-weight: bold">for </span>line <span style="color: blue; font-weight: bold">in </span>src<span style="font-weight: bold">.</span>split<span style="font-weight: bold">(</span><span style="color: red">'\n'</span><span style="font-weight: bold">)]
    </span><span style="color: blue; font-weight: bold">if </span>join_str <span style="color: blue; font-weight: bold">is not </span><span style="color: blue">None</span><span style="font-weight: bold">:
        </span>result <span style="font-weight: bold">= </span>join_str<span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>result<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">return </span>result

<span style="color: blue; font-weight: bold">def </span>underline<span style="font-weight: bold">(</span>line<span style="font-weight: bold">, </span>under<span style="font-weight: bold">=</span><span style="color: red">'='</span><span style="font-weight: bold">):
    </span><span style="color: darkred">"""Prints an underlined version of the given line with the
    specified underline style.

    PARAMETERS:
    line  -- str
    under -- str; a one-character string that specifies the underline
             style
    """
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>line <span style="font-weight: bold">+ </span><span style="color: red">'\n' </span><span style="font-weight: bold">+ </span>under <span style="font-weight: bold">* </span>len<span style="font-weight: bold">(</span>line<span style="font-weight: bold">))

</span>PS1 <span style="font-weight: bold">= </span><span style="color: red">'&gt;&gt;&gt; '
</span>PS2 <span style="font-weight: bold">= </span><span style="color: red">'... '

</span><span style="color: green; font-style: italic">#####################
# TIMEOUT MECHANISM #
#####################

</span><span style="color: blue; font-weight: bold">class </span>TimeoutError<span style="font-weight: bold">(</span>Exception<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Exception for timeouts."""
    </span>_message <span style="font-weight: bold">= </span><span style="color: red">'Evaluation timed out!'

    </span><span style="color: blue; font-weight: bold">def </span>__init__<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">, </span>timeout<span style="font-weight: bold">):
        </span><span style="color: darkred">"""Constructor.

        PARAMTERS:
        timeout -- int; number of seconds before timeout error occurred
        """
        </span>super<span style="font-weight: bold">().</span>__init__<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">)
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>timeout <span style="font-weight: bold">= </span>timeout

<span style="color: blue; font-weight: bold">class </span>ReturningThread<span style="font-weight: bold">(</span>Thread<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Creates a daemon Thread with a result variable."""
    </span><span style="color: blue; font-weight: bold">def </span>__init__<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">, </span>fn<span style="font-weight: bold">, </span>args<span style="font-weight: bold">, </span>kargs<span style="font-weight: bold">):
        </span>Thread<span style="font-weight: bold">.</span>__init__<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">)
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>daemon <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">True
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>result <span style="font-weight: bold">= </span><span style="color: blue">None
        self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span><span style="color: blue">None
        self</span><span style="font-weight: bold">.</span>fn <span style="font-weight: bold">= </span>fn
        <span style="color: blue">self</span><span style="font-weight: bold">.</span>args <span style="font-weight: bold">= </span>args
        <span style="color: blue">self</span><span style="font-weight: bold">.</span>kargs <span style="font-weight: bold">= </span>kargs

    <span style="color: blue; font-weight: bold">def </span>run<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>result <span style="font-weight: bold">= </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>fn<span style="font-weight: bold">(*</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>args<span style="font-weight: bold">, **</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>kargs<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">except </span>Exception as e<span style="font-weight: bold">:
            </span>e<span style="font-weight: bold">.</span>_message <span style="font-weight: bold">= </span>traceback<span style="font-weight: bold">.</span>format_exc<span style="font-weight: bold">(</span>limit<span style="font-weight: bold">=</span><span style="color: red">2</span><span style="font-weight: bold">)
            </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span>e

TIMEOUT <span style="font-weight: bold">= </span><span style="color: red">10
</span><span style="color: blue; font-weight: bold">def </span>timed<span style="font-weight: bold">(</span>fn<span style="font-weight: bold">, </span>args<span style="font-weight: bold">=(), </span>kargs<span style="font-weight: bold">={}, </span>timeout<span style="font-weight: bold">=</span><span style="color: red">0</span><span style="font-weight: bold">):
    </span><span style="color: darkred">"""Evaluates expr in the given frame.

    PARAMETERS:
    fn      -- function; Python function to be evaluated
    args    -- tuple; positional arguments for fn
    kargs   -- dict; keyword arguments for fn
    timeout -- int; number of seconds before timer interrupt (defaults
               to TIMEOUT

    RETURN:
    Result of calling fn(*args, **kargs).

    RAISES:
    TimeoutError -- if thread takes longer than timemout to execute
    Error        -- if calling fn raises an error, raise it
    """
    </span><span style="color: blue; font-weight: bold">if not </span>timeout<span style="font-weight: bold">:
        </span>timeout <span style="font-weight: bold">= </span>TIMEOUT
    submission <span style="font-weight: bold">= </span>ReturningThread<span style="font-weight: bold">(</span>fn<span style="font-weight: bold">, </span>args<span style="font-weight: bold">, </span>kargs<span style="font-weight: bold">)
    </span>submission<span style="font-weight: bold">.</span>start<span style="font-weight: bold">()
    </span>submission<span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>timeout<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>submission<span style="font-weight: bold">.</span>is_alive<span style="font-weight: bold">():
        </span><span style="color: blue; font-weight: bold">raise </span>TimeoutError<span style="font-weight: bold">(</span>timeout<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>submission<span style="font-weight: bold">.</span>error <span style="color: blue; font-weight: bold">is not </span><span style="color: blue">None</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">raise </span>submission<span style="font-weight: bold">.</span>error
    <span style="color: blue; font-weight: bold">return </span>submission<span style="font-weight: bold">.</span>result

<span style="color: green; font-style: italic">#####################
# Testing Mechanism #
#####################

</span><span style="color: blue; font-weight: bold">def </span>get_name<span style="font-weight: bold">(</span>test<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Gets the name of a test.

    PARAMETERS:
    test -- dict; test cases for a question. Expected to contain a key
            'name', which either maps to a string or a iterable of
            strings (in which case the first string will be used)

    RETURNS:
    str; the name of the test
    """
    </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'name'</span><span style="font-weight: bold">]) == </span>str<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">return </span>test<span style="font-weight: bold">[</span><span style="color: red">'name'</span><span style="font-weight: bold">]
    </span><span style="color: blue; font-weight: bold">return </span>test<span style="font-weight: bold">[</span><span style="color: red">'name'</span><span style="font-weight: bold">][</span><span style="color: red">0</span><span style="font-weight: bold">]

</span><span style="color: blue; font-weight: bold">def </span>get_test<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">, </span>question<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Retrieves a test for the specified question in the given list
    of tests.

    PARAMETERS:
    tests    -- list of dicts; list of tests
    question -- str; name of test

    RETURNS:
    dict; the test corresponding to question. If no such test is found,
    return None
    """
    </span><span style="color: blue; font-weight: bold">for </span>test <span style="color: blue; font-weight: bold">in </span>tests<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'name' </span><span style="color: blue; font-weight: bold">not in </span>test<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">continue
        </span>names <span style="font-weight: bold">= </span>test<span style="font-weight: bold">[</span><span style="color: red">'name'</span><span style="font-weight: bold">]
        </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span>names<span style="font-weight: bold">) == </span>str<span style="font-weight: bold">:
            </span>names <span style="font-weight: bold">= (</span>names<span style="font-weight: bold">,)
        </span><span style="color: blue; font-weight: bold">if </span>question <span style="color: blue; font-weight: bold">in </span>names<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">return </span>test
    <span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Tests do not exist for "{}"'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>question<span style="font-weight: bold">))
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Try one of the following:'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(*(</span>test<span style="font-weight: bold">[</span><span style="color: red">'name'</span><span style="font-weight: bold">][</span><span style="color: red">0</span><span style="font-weight: bold">] </span><span style="color: blue; font-weight: bold">for </span>test <span style="color: blue; font-weight: bold">in </span>tests<span style="font-weight: bold">))

</span><span style="color: blue; font-weight: bold">class </span>AutograderConsole<span style="font-weight: bold">():
    </span><span style="color: darkred">"""Handles test evaluation and output formatting for a single
    test case.

    An instance of this class is designed to be used for exactly
    one test case. While the run method can technically be called
    more than once, the namespace (self.frame) will retain any changes
    caused by the code; as a result, different behavior may occur
    across multiple calls to run.

    Each instance of this class keeps an output log, which can be
    registered with the OutputLogger class. External code can access
    this log to replay output at a later time.

    This class also supports an interact method, which should only be
    called after calling the run method. interact will start an
    InteractiveConsole with the current state of the namespace. Lines
    that were executed by the run method are also saved to the
    readline history.
    """

    </span><span style="color: blue; font-weight: bold">def </span>__init__<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">, </span>code<span style="font-weight: bold">, </span>outputs<span style="font-weight: bold">, </span>frame<span style="font-weight: bold">, </span>postamble<span style="font-weight: bold">):
        </span><span style="color: darkred">"""Constructor

        PARAMETERS:
        code      -- str; code to be executed. Lines will be determined
                     by the split function. Any preambles should be
                     included here
        outputs   -- list; a sequence of outputs. the length of outputs
                     is assumed to be equal to the number of prompts
                     in the code parameter (each prompt is denoted by
                     a "$ ")
        frame     -- dict; namespace in which the code should be
                     executed. A copy of frame is used, so the orignal
                     frame is not mutated
        postamble -- str; teardown code that should be executed after
                     the test case finishes, even if an early abort
                     occurs
        """
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>frame <span style="font-weight: bold">= </span>frame<span style="font-weight: bold">.</span>copy<span style="font-weight: bold">()
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>code <span style="font-weight: bold">= </span>code
        <span style="color: blue">self</span><span style="font-weight: bold">.</span>outputs <span style="font-weight: bold">= </span>iter<span style="font-weight: bold">(</span>outputs<span style="font-weight: bold">)
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">False
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>postamble <span style="font-weight: bold">= </span>postamble
        <span style="color: blue">self</span><span style="font-weight: bold">.</span>log <span style="font-weight: bold">= []

    </span><span style="color: blue; font-weight: bold">def </span>run<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: darkred">"""Executes lines of code in the namespace provided to the
        constructor.

        The instance's output log is registered with the OutputLogger
        to capture output. This log can be replayed by external code
        at a later time.

        Formatting is designed to mimic a Python interpreter, with
        uses of PS1 and PS2 for each line of code. Lines of code that
        are executed are also stored in the readline history for use
        with interactive mode.

        The postamble is always executed at the end, even if a test
        error causes a premature abort.
        """
        </span>current  <span style="font-weight: bold">= </span><span style="color: red">''
        </span>lines <span style="font-weight: bold">= </span>split<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>code<span style="font-weight: bold">) + [</span><span style="color: red">''</span><span style="font-weight: bold">]
        </span>logger<span style="font-weight: bold">.</span>register_log<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>log<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">if </span>READLINE_FLAG<span style="font-weight: bold">:
            </span>readline<span style="font-weight: bold">.</span>clear_history<span style="font-weight: bold">()
        </span><span style="color: blue; font-weight: bold">for </span>i<span style="font-weight: bold">, </span>line <span style="color: blue; font-weight: bold">in </span>enumerate<span style="font-weight: bold">(</span>lines<span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">if </span>READLINE_FLAG <span style="color: blue; font-weight: bold">and </span>line<span style="font-weight: bold">:
                </span>readline<span style="font-weight: bold">.</span>add_history<span style="font-weight: bold">(</span>line<span style="font-weight: bold">.</span>replace<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">))

            </span><span style="color: blue; font-weight: bold">if </span>line<span style="font-weight: bold">.</span>startswith<span style="font-weight: bold">(</span><span style="color: red">' '</span><span style="font-weight: bold">) </span><span style="color: blue; font-weight: bold">or </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>incomplete<span style="font-weight: bold">(</span>current<span style="font-weight: bold">):
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>PS2 <span style="font-weight: bold">+ </span>line<span style="font-weight: bold">)
                </span>current <span style="font-weight: bold">+= </span>line <span style="font-weight: bold">+ </span><span style="color: red">'\n'
                </span><span style="color: blue; font-weight: bold">continue

            if </span>current<span style="font-weight: bold">.</span>startswith<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">):
                </span>output <span style="font-weight: bold">= </span>next<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>outputs<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span>output<span style="font-weight: bold">) == </span>tuple<span style="font-weight: bold">:
                    </span>output <span style="font-weight: bold">= </span>output<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">]
                </span><span style="color: blue">self</span><span style="font-weight: bold">.</span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span>current<span style="font-weight: bold">.</span>replace<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">), </span>output<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">if </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error<span style="font-weight: bold">:
                    </span><span style="color: blue; font-weight: bold">break
            else</span><span style="font-weight: bold">:
                </span><span style="color: blue">self</span><span style="font-weight: bold">.</span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span>current<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">if </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error<span style="font-weight: bold">:
                    </span><span style="color: blue; font-weight: bold">break
            </span>current <span style="font-weight: bold">= </span>line <span style="font-weight: bold">+ </span><span style="color: red">'\n'
            </span><span style="color: blue; font-weight: bold">if </span>line <span style="font-weight: bold">!= </span><span style="color: red">''</span><span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>PS1 <span style="font-weight: bold">+ </span>line<span style="font-weight: bold">.</span>replace<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">))
        </span>logger<span style="font-weight: bold">.</span>register_log<span style="font-weight: bold">(</span><span style="color: blue">None</span><span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">def </span>cleanup<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: blue">self</span><span style="font-weight: bold">.</span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>postamble<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">def exec</span><span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">, </span>expr<span style="font-weight: bold">, </span>expected<span style="font-weight: bold">=</span><span style="color: blue">None</span><span style="font-weight: bold">):
        </span><span style="color: darkred">"""Executes or evaluates a given expression.

        PARAMETERS:
        expr     -- str; expression to be executed or evaluated
        expected -- str; the expected expression, used to compare
                    against the result of evaluating expr. If expected
                    is not None, the function uses eval instead of
                    exec

        DESCRIPTION:
        If expected is None, expr is processed using the built-in exec
        function. If expected is a string, expr and expected will be
        processed using the built-in eval function, and will be
        tested for equality as defined by the == operator.

        Errors are caught and printed. Special output messages are used
        for RuntimeErrors (maximum recursion depth) and TimeoutErrors.
        In addition, expected can be a subclass of Exception, in which
        case success occurs only when an instance of that exception is
        raised.

        All code execution occurs in the namespace provided to the
        constructor. Any changes to the namespace (e.g. variable
        definitions) will be preserved.
        """
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">if </span>expected<span style="font-weight: bold">:
                </span>expect <span style="font-weight: bold">= </span>timed<span style="font-weight: bold">(</span>eval<span style="font-weight: bold">, (</span>expected<span style="font-weight: bold">, </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>frame<span style="font-weight: bold">.</span>copy<span style="font-weight: bold">()))
                </span>actual <span style="font-weight: bold">= </span>timed<span style="font-weight: bold">(</span>eval<span style="font-weight: bold">, (</span>expr<span style="font-weight: bold">, </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>frame<span style="font-weight: bold">))
            </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
                </span>expect <span style="font-weight: bold">= </span><span style="color: blue">None
                </span>actual <span style="font-weight: bold">= </span>timed<span style="font-weight: bold">(</span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">, (</span>expr<span style="font-weight: bold">, </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>frame<span style="font-weight: bold">))
        </span><span style="color: blue; font-weight: bold">except </span>RuntimeError<span style="font-weight: bold">:
            </span>stacktrace <span style="font-weight: bold">= </span>traceback<span style="font-weight: bold">.</span>format_exc<span style="font-weight: bold">()
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Traceback (most recent call last):\n  ...'</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'\n'</span><span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>split<span style="font-weight: bold">(</span>stacktrace<span style="font-weight: bold">)[-</span><span style="color: red">9</span><span style="font-weight: bold">:-</span><span style="color: red">1</span><span style="font-weight: bold">]))
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'# Error: maximum recursion depth exceeded.'</span><span style="font-weight: bold">)
            </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">True
        except </span>TimeoutError as e<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'# Error: evaluation exceeded {} seconds.'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(
                  </span>e<span style="font-weight: bold">.</span>timeout<span style="font-weight: bold">))
            </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">True
        except </span>Exception as e<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span>expect<span style="font-weight: bold">) == </span>type <span style="color: blue; font-weight: bold">and </span>\
                    issubclass<span style="font-weight: bold">(</span>expect<span style="font-weight: bold">, </span>BaseException<span style="font-weight: bold">) </span><span style="color: blue; font-weight: bold">and </span>\
                    isinstance<span style="font-weight: bold">(</span>e<span style="font-weight: bold">, </span>expect<span style="font-weight: bold">):
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>e<span style="font-weight: bold">.</span>__class__<span style="font-weight: bold">.</span>__name__ <span style="font-weight: bold">+ </span><span style="color: red">':'</span><span style="font-weight: bold">, </span>e<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">return
            </span>stacktrace <span style="font-weight: bold">= </span>traceback<span style="font-weight: bold">.</span>format_exc<span style="font-weight: bold">()
            </span>token <span style="font-weight: bold">= </span><span style="color: red">'&lt;module&gt;\n'
            </span>index <span style="font-weight: bold">= </span>stacktrace<span style="font-weight: bold">.</span>rfind<span style="font-weight: bold">(</span>token<span style="font-weight: bold">) + </span>len<span style="font-weight: bold">(</span>token<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Traceback (most recent call last):'</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>stacktrace<span style="font-weight: bold">[</span>index<span style="font-weight: bold">:])
            </span><span style="color: blue; font-weight: bold">if </span>expected <span style="color: blue; font-weight: bold">is not </span><span style="color: blue">None</span><span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'# Error: expected'</span><span style="font-weight: bold">, </span>repr<span style="font-weight: bold">(</span>expect<span style="font-weight: bold">), </span><span style="color: red">"got"</span><span style="font-weight: bold">,
                      </span>e<span style="font-weight: bold">.</span>__class__<span style="font-weight: bold">.</span>__name__<span style="font-weight: bold">)
            </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">True
        else</span><span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">if </span>expected<span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>repr<span style="font-weight: bold">(</span>actual<span style="font-weight: bold">))
            </span><span style="color: blue; font-weight: bold">if </span>expected <span style="color: blue; font-weight: bold">and </span>expect <span style="font-weight: bold">!= </span>actual<span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'# Error: expected'</span><span style="font-weight: bold">, </span>repr<span style="font-weight: bold">(</span>expect<span style="font-weight: bold">), </span><span style="color: red">'got'</span><span style="font-weight: bold">,
                      </span>repr<span style="font-weight: bold">(</span>actual<span style="font-weight: bold">))
                </span><span style="color: blue">self</span><span style="font-weight: bold">.</span>error <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">True

    def </span>interact<span style="font-weight: bold">(</span><span style="color: blue">self</span><span style="font-weight: bold">):
        </span><span style="color: darkred">"""Starts an InteractiveConsole."""
        </span>sys<span style="font-weight: bold">.</span>stdout <span style="font-weight: bold">= </span>sys<span style="font-weight: bold">.</span>__stdout__
        console <span style="font-weight: bold">= </span>InteractiveConsole<span style="font-weight: bold">(</span>locals<span style="font-weight: bold">=</span><span style="color: blue">self</span><span style="font-weight: bold">.</span>frame<span style="font-weight: bold">)
        </span>console<span style="font-weight: bold">.</span>interact<span style="font-weight: bold">(</span><span style="color: red">'# Interactive console.'
                         ' Type exit() to quit'</span><span style="font-weight: bold">)
        </span>sys<span style="font-weight: bold">.</span>stdout <span style="font-weight: bold">= </span>logger

    @staticmethod
    <span style="color: blue; font-weight: bold">def </span>incomplete<span style="font-weight: bold">(</span>line<span style="font-weight: bold">):
        </span><span style="color: darkred">"""Subroutine for checking if the given line can be a complete
        Python line of code.
        """
        </span><span style="color: blue; font-weight: bold">return </span>compile_command<span style="font-weight: bold">(</span>line<span style="font-weight: bold">.</span>replace<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">)) </span><span style="color: blue; font-weight: bold">is </span><span style="color: blue">None

</span><span style="color: blue; font-weight: bold">def </span>run<span style="font-weight: bold">(</span>test<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">, </span>interactive<span style="font-weight: bold">, </span>preamble<span style="font-weight: bold">, </span>verbose<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Runs all test suites for this class.

    PARAMETERS:
    test         -- dict; test cases for a single question
    global_frame -- dict; bindings for the global frame
    interactive  -- bool; True if interactive mode is enabled
    preamble     -- str; preamble that is executed for every test
    verbose      -- bool; True if verbose mode is toggled on

    DESCRIPTION:
    Test suites should be correspond to the key 'suites' in test.
    If no such key exists, run as if zero suites are
    defined. Use the first value corresponding to the key 'name' in
    test as the name of the test.

    RETURNS:
    bool; True if all suites passed.
    """
    </span>name <span style="font-weight: bold">= </span>get_name<span style="font-weight: bold">(</span>test<span style="font-weight: bold">)
    </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Test ' </span><span style="font-weight: bold">+ </span>name<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'note' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>split<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'note'</span><span style="font-weight: bold">], </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n'</span><span style="font-weight: bold">))
    </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'cache' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span>cache <span style="font-weight: bold">= </span>compile<span style="font-weight: bold">(</span>split<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'cache'</span><span style="font-weight: bold">], </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n'</span><span style="font-weight: bold">),
                            </span><span style="color: red">'{} cache'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>name<span style="font-weight: bold">), </span><span style="color: red">'exec'</span><span style="font-weight: bold">)
            </span>timed<span style="font-weight: bold">(</span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">, (</span>cache<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">))
        </span><span style="color: blue; font-weight: bold">except </span>Exception as e<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Cache for'</span><span style="font-weight: bold">, </span>name<span style="font-weight: bold">, </span><span style="color: red">'errored:'</span><span style="font-weight: bold">, </span>e<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'preamble' </span><span style="color: blue; font-weight: bold">in </span>test <span style="color: blue; font-weight: bold">and </span><span style="color: red">'all' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">]:
        </span>preamble <span style="font-weight: bold">+= </span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">][</span><span style="color: red">'all'</span><span style="font-weight: bold">]
    </span>postamble <span style="font-weight: bold">= </span><span style="color: red">''
    </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'postamble' </span><span style="color: blue; font-weight: bold">in </span>test <span style="color: blue; font-weight: bold">and </span><span style="color: red">'all' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">[</span><span style="color: red">'postamble'</span><span style="font-weight: bold">]:
        </span>postamble <span style="font-weight: bold">= </span>test<span style="font-weight: bold">[</span><span style="color: red">'postamble'</span><span style="font-weight: bold">][</span><span style="color: red">'all'</span><span style="font-weight: bold">]

    </span>total_passed <span style="font-weight: bold">= </span><span style="color: red">0
    </span>total_cases <span style="font-weight: bold">= </span><span style="color: red">0
    </span><span style="color: blue; font-weight: bold">for </span>counter<span style="font-weight: bold">, </span>suite <span style="color: blue; font-weight: bold">in </span>enumerate<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'suites'</span><span style="font-weight: bold">]):
        </span><span style="color: green; font-style: italic"># Preamble and Postamble
        </span>new_preamble <span style="font-weight: bold">= </span>preamble
        <span style="color: blue; font-weight: bold">if </span><span style="color: red">'preamble' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">:
            </span>new_preamble <span style="font-weight: bold">+= </span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">].</span>get<span style="font-weight: bold">(</span>counter<span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">)
        </span>new_postamble <span style="font-weight: bold">= </span>postamble
        <span style="color: blue; font-weight: bold">if </span><span style="color: red">'postamble' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">:
            </span>new_postamble <span style="font-weight: bold">+= </span>test<span style="font-weight: bold">[</span><span style="color: red">'postamble'</span><span style="font-weight: bold">].</span>get<span style="font-weight: bold">(</span>counter<span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">)

        </span><span style="color: green; font-style: italic"># Run tests
        </span>passed<span style="font-weight: bold">, </span>abort <span style="font-weight: bold">= </span>run_suite<span style="font-weight: bold">(</span>suite<span style="font-weight: bold">, </span>new_preamble<span style="font-weight: bold">, </span>new_postamble<span style="font-weight: bold">,
                               </span>global_frame<span style="font-weight: bold">, </span>verbose<span style="font-weight: bold">, </span>interactive<span style="font-weight: bold">, </span>total_cases<span style="font-weight: bold">)
        </span>total_passed <span style="font-weight: bold">+= </span>passed
        total_cases <span style="font-weight: bold">+= </span>sum<span style="font-weight: bold">(</span><span style="color: red">1 </span><span style="color: blue; font-weight: bold">for </span>case <span style="color: blue; font-weight: bold">in </span>suite <span style="color: blue; font-weight: bold">if </span><span style="color: red">'concept' </span><span style="color: blue; font-weight: bold">not in </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">] </span><span style="color: blue; font-weight: bold">and </span><span style="color: red">'unlock' </span><span style="color: blue; font-weight: bold">in </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">])
        </span><span style="color: blue; font-weight: bold">if </span>abort<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">break

    </span>locked_cases <span style="font-weight: bold">= </span>sum<span style="font-weight: bold">(</span><span style="color: red">1 </span><span style="color: blue; font-weight: bold">for </span>suite <span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">[</span><span style="color: red">'suites'</span><span style="font-weight: bold">]
                         </span><span style="color: blue; font-weight: bold">for </span>case <span style="color: blue; font-weight: bold">in </span>suite <span style="color: blue; font-weight: bold">if </span><span style="color: red">'unlock' </span><span style="color: blue; font-weight: bold">not in </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">])

    </span><span style="color: blue; font-weight: bold">if </span>total_passed <span style="font-weight: bold">== </span>total_cases<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'All unlocked tests passed!'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>locked_cases <span style="font-weight: bold">&gt; </span><span style="color: red">0</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'-- NOTE: {} still has {} locked cases! --'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>name<span style="font-weight: bold">,
              </span>locked_cases<span style="font-weight: bold">))
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()
    </span><span style="color: blue; font-weight: bold">return </span>total_passed <span style="font-weight: bold">== </span>total_cases

<span style="color: blue; font-weight: bold">def </span>run_suite<span style="font-weight: bold">(</span>suite<span style="font-weight: bold">, </span>preamble<span style="font-weight: bold">, </span>postamble<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">, </span>verbose<span style="font-weight: bold">, </span>interactive<span style="font-weight: bold">, </span>cases<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Runs tests for a single suite.

    PARAMETERS:
    suite        -- list; each element is a test case, represented as a
                    3-tuple
    preamble     -- str; the preamble that should be run before every
                    test
    postamble    -- str; the postamble that should be run after every
                    test case
    global_frame -- dict; global frame
    verbose      -- bool; True if verbose mode is toggled on
    interactive  -- bool; True if interactive mode is toggled on
    cases        -- int; number of cases that preceded the current
                    suite

    DESCRIPTION:
    Each test case in the parameter suite is represented as a
    3-tuple

        (input, outputs, status)

    where:
    input   -- str; a (possibly multiline) string of Python
               source code
    outputs -- iterable or string; if string, outputs is the
               sole expected output. If iterable, each element
               in outputs should correspond to an input slot
               in input (delimited by '$ ').
    status  -- str; contains substrings to denote status

    For each test, a new frame is created and houses all bindings
    made by the test. The preamble will run first (if it exists)
    before the test input. The postamble will be run after the test.

    Expected output and actual output are tested on shallow equality
    (==). If a test fails, a TestError will be raised that
    contains information about the test.

    The OutputLogger should always be set to standard output before
    calling this function, and it will always be set to standard
    output after leaving this function.

    RETURNS:
    bool; True if not all cases unlocked

    RAISES:
    TestError; contains information about the test that failed.
    """
    </span>passed <span style="font-weight: bold">= </span><span style="color: red">0
    </span>case_num <span style="font-weight: bold">= </span>cases
    preamble <span style="font-weight: bold">= </span>split<span style="font-weight: bold">(</span>preamble<span style="font-weight: bold">, </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n'</span><span style="font-weight: bold">)
    </span>postamble <span style="font-weight: bold">= </span>split<span style="font-weight: bold">(</span>postamble<span style="font-weight: bold">, </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">for </span>case<span style="font-weight: bold">, </span>outputs<span style="font-weight: bold">, </span>status <span style="color: blue; font-weight: bold">in </span>suite<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'unlock' </span><span style="color: blue; font-weight: bold">not in </span>status<span style="font-weight: bold">:
            </span>logger<span style="font-weight: bold">.</span>on<span style="font-weight: bold">()
            </span><span style="color: blue; font-weight: bold">return </span>passed<span style="font-weight: bold">, </span><span style="color: blue; font-weight: bold">True  </span><span style="color: green; font-style: italic"># students must unlock first
        </span><span style="color: blue; font-weight: bold">elif </span><span style="color: red">'concept' </span><span style="color: blue; font-weight: bold">in </span>status <span style="color: blue; font-weight: bold">and </span>verbose<span style="font-weight: bold">:
            </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Concept question'</span><span style="font-weight: bold">, </span>under<span style="font-weight: bold">=</span><span style="color: red">'-'</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'   '</span><span style="font-weight: bold">, </span>split<span style="font-weight: bold">(</span>case<span style="font-weight: bold">, </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n    '</span><span style="font-weight: bold">))
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'\n    A:'</span><span style="font-weight: bold">, </span>split<span style="font-weight: bold">(</span>outputs<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">], </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n    '</span><span style="font-weight: bold">))
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()
        </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'concept' </span><span style="color: blue; font-weight: bold">in </span>status<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">continue

        </span>case_num <span style="font-weight: bold">+= </span><span style="color: red">1
        </span><span style="color: blue; font-weight: bold">if not </span>verbose<span style="font-weight: bold">:
            </span>logger<span style="font-weight: bold">.</span>off<span style="font-weight: bold">()
        </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Case {}'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>case_num<span style="font-weight: bold">), </span>under<span style="font-weight: bold">=</span><span style="color: red">'-'</span><span style="font-weight: bold">)

        </span>num_prompts <span style="font-weight: bold">= </span>case<span style="font-weight: bold">.</span>count<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">)
        </span>case <span style="font-weight: bold">= </span>split<span style="font-weight: bold">(</span>case<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">if </span>num_prompts <span style="font-weight: bold">== </span><span style="color: red">0</span><span style="font-weight: bold">:
            </span>case<span style="font-weight: bold">[-</span><span style="color: red">1</span><span style="font-weight: bold">] = </span><span style="color: red">'$ ' </span><span style="font-weight: bold">+ </span>case<span style="font-weight: bold">[-</span><span style="color: red">1</span><span style="font-weight: bold">]
            </span>num_prompts <span style="font-weight: bold">+= </span><span style="color: red">1
        </span><span style="color: blue; font-weight: bold">assert </span>num_prompts <span style="font-weight: bold">== </span>len<span style="font-weight: bold">(</span>outputs<span style="font-weight: bold">), </span><span style="color: red">'Improper number of prompts'
        </span>code <span style="font-weight: bold">= </span>preamble <span style="font-weight: bold">+ </span><span style="color: red">'\n' </span><span style="font-weight: bold">+ </span><span style="color: red">'\n'</span><span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>case<span style="font-weight: bold">)
        </span>console <span style="font-weight: bold">= </span>AutograderConsole<span style="font-weight: bold">(</span>code<span style="font-weight: bold">, </span>outputs<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">,
                                    </span>postamble<span style="font-weight: bold">)
        </span>console<span style="font-weight: bold">.</span>run<span style="font-weight: bold">()
        </span><span style="color: blue; font-weight: bold">if </span>console<span style="font-weight: bold">.</span>error <span style="color: blue; font-weight: bold">and not </span>verbose<span style="font-weight: bold">:
            </span>logger<span style="font-weight: bold">.</span>on<span style="font-weight: bold">()
            </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Case {} failed'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>case_num<span style="font-weight: bold">), </span>under<span style="font-weight: bold">=</span><span style="color: red">'-'</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">''</span><span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>console<span style="font-weight: bold">.</span>log<span style="font-weight: bold">).</span>strip<span style="font-weight: bold">())
        </span><span style="color: blue; font-weight: bold">if </span>console<span style="font-weight: bold">.</span>error <span style="color: blue; font-weight: bold">and </span>interactive<span style="font-weight: bold">:
            </span>console<span style="font-weight: bold">.</span>interact<span style="font-weight: bold">()
        </span>console<span style="font-weight: bold">.</span>cleanup<span style="font-weight: bold">()
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()
        </span><span style="color: blue; font-weight: bold">if </span>console<span style="font-weight: bold">.</span>error<span style="font-weight: bold">:
            </span>logger<span style="font-weight: bold">.</span>on<span style="font-weight: bold">()
            </span><span style="color: blue; font-weight: bold">return </span>passed<span style="font-weight: bold">, </span><span style="color: blue; font-weight: bold">True
        </span>passed <span style="font-weight: bold">+= </span><span style="color: red">1
    </span>logger<span style="font-weight: bold">.</span>on<span style="font-weight: bold">()
    </span><span style="color: blue; font-weight: bold">return </span>passed<span style="font-weight: bold">, </span><span style="color: blue; font-weight: bold">False

</span><span style="color: green; font-style: italic">#######################
# UNLOCKING MECHANISM #
#######################

</span><span style="color: blue; font-weight: bold">def </span>unlock<span style="font-weight: bold">(</span>question<span style="font-weight: bold">, </span>tests<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Unlocks a question, given locked_tests and unlocked_tests.

    PARAMETERS:
    question -- str; the name of the test
    tests    -- module; contains a list of locked tests

    DESCRIPTION:
    This function incrementally unlocks all cases in a specified
    question. Students must answer in the order that test cases are
    written. Once a test case is unlocked, it will remain unlocked.

    Persistant state is stored by rewriting the contents of
    tests.pkl. Students should NOT manually change these files.
    """
    </span>hash_key <span style="font-weight: bold">= </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'hash_key'</span><span style="font-weight: bold">]
    </span>imports <span style="font-weight: bold">= </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'imports'</span><span style="font-weight: bold">]

    </span>test <span style="font-weight: bold">= </span>get_test<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">[</span><span style="color: red">'tests'</span><span style="font-weight: bold">], </span>question<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>test <span style="color: blue; font-weight: bold">is </span><span style="color: blue">None</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">return
    </span>name <span style="font-weight: bold">= </span>get_name<span style="font-weight: bold">(</span>test<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'suites' </span><span style="color: blue; font-weight: bold">not in </span>test<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'No tests to unlock for {}.'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>name<span style="font-weight: bold">))
        </span><span style="color: blue; font-weight: bold">return

    </span>prompt <span style="font-weight: bold">= </span><span style="color: red">'?'
    </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Unlocking tests for {}'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>name<span style="font-weight: bold">))
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'At each "{}", type in what you would expect the output to '
          'be if you had implemented {}'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>prompt<span style="font-weight: bold">, </span>name<span style="font-weight: bold">))
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Type exit() to quit'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()

    </span>global_frame <span style="font-weight: bold">= {}
    </span><span style="color: blue; font-weight: bold">for </span>line <span style="color: blue; font-weight: bold">in </span>imports<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span>line<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">def </span>hash_fn<span style="font-weight: bold">(</span>x<span style="font-weight: bold">):
        </span><span style="color: blue; font-weight: bold">return </span>hmac<span style="font-weight: bold">.</span>new<span style="font-weight: bold">(</span>hash_key<span style="font-weight: bold">.</span>encode<span style="font-weight: bold">(</span><span style="color: red">'utf-8'</span><span style="font-weight: bold">),
                        </span>x<span style="font-weight: bold">.</span>encode<span style="font-weight: bold">(</span><span style="color: red">'utf-8'</span><span style="font-weight: bold">)).</span>digest<span style="font-weight: bold">()

    </span>preamble <span style="font-weight: bold">= </span>split<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">])
    </span>cases <span style="font-weight: bold">= </span><span style="color: red">0
    </span><span style="color: blue; font-weight: bold">for </span>suite_num<span style="font-weight: bold">, </span>suite <span style="color: blue; font-weight: bold">in </span>enumerate<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'suites'</span><span style="font-weight: bold">]):
        </span><span style="color: blue; font-weight: bold">if not </span>suite<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">continue
        </span>new_preamble <span style="font-weight: bold">= </span>preamble
        <span style="color: blue; font-weight: bold">if </span><span style="color: red">'preamble' </span><span style="color: blue; font-weight: bold">in </span>test <span style="color: blue; font-weight: bold">and </span><span style="color: red">'all' </span><span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">]:
            </span>new_preamble <span style="font-weight: bold">= </span>new_preamble <span style="font-weight: bold">+ </span>split<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">][</span><span style="color: red">'all'</span><span style="font-weight: bold">])
        </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'preamble' </span><span style="color: blue; font-weight: bold">in </span>test <span style="color: blue; font-weight: bold">and </span>suite_num <span style="color: blue; font-weight: bold">in </span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">]:
            </span>new_preamble <span style="font-weight: bold">= </span>new_preamble <span style="font-weight: bold">+ </span>split<span style="font-weight: bold">(</span>test<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">][</span>suite_num<span style="font-weight: bold">])
        </span><span style="color: blue; font-weight: bold">for </span>case_num<span style="font-weight: bold">, </span>case <span style="color: blue; font-weight: bold">in </span>enumerate<span style="font-weight: bold">(</span>suite<span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'concept' </span><span style="color: blue; font-weight: bold">not in </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">]:
                </span>cases <span style="font-weight: bold">+= </span><span style="color: red">1
            </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'unlock' </span><span style="color: blue; font-weight: bold">in </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">]:
                </span><span style="color: blue; font-weight: bold">continue
            elif </span><span style="color: red">'concept' </span><span style="color: blue; font-weight: bold">in </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">]:
                </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Concept Question'</span><span style="font-weight: bold">, </span>under<span style="font-weight: bold">=</span><span style="color: red">'-'</span><span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>split<span style="font-weight: bold">(</span>case<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">], </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n'</span><span style="font-weight: bold">))
                </span>answer <span style="font-weight: bold">= </span>handle_student_input<span style="font-weight: bold">(</span>case<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">][</span><span style="color: red">0</span><span style="font-weight: bold">], </span>prompt<span style="font-weight: bold">, </span>hash_fn<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">if </span>answer <span style="color: blue; font-weight: bold">is </span><span style="color: blue">None</span><span style="font-weight: bold">:
                    </span><span style="color: blue; font-weight: bold">return
                </span>case<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">] = [</span>answer<span style="font-weight: bold">]
                </span>case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">] += </span><span style="color: red">'unlock'
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"-- Congratulations, you have unlocked this case! --"</span><span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()
                </span><span style="color: blue; font-weight: bold">continue

            </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Case {}'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>cases<span style="font-weight: bold">), </span>under<span style="font-weight: bold">=</span><span style="color: red">'-'</span><span style="font-weight: bold">)
            </span>num_prompts <span style="font-weight: bold">= </span>case<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">].</span>count<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">)
            </span>test_case <span style="font-weight: bold">= </span>split<span style="font-weight: bold">(</span>case<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">])
            </span><span style="color: blue; font-weight: bold">if </span>num_prompts <span style="font-weight: bold">== </span><span style="color: red">0</span><span style="font-weight: bold">:
                </span>test_case<span style="font-weight: bold">[-</span><span style="color: red">1</span><span style="font-weight: bold">] = </span><span style="color: red">'$ ' </span><span style="font-weight: bold">+ </span>test_case<span style="font-weight: bold">[-</span><span style="color: red">1</span><span style="font-weight: bold">]
                </span>num_prompts <span style="font-weight: bold">+= </span><span style="color: red">1
            </span><span style="color: blue; font-weight: bold">assert </span>num_prompts <span style="font-weight: bold">== </span>len<span style="font-weight: bold">(</span>case<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">]), </span><span style="color: red">'Improper number of prompts'
            </span>lines <span style="font-weight: bold">= </span>new_preamble <span style="font-weight: bold">+ </span>test_case
            outputs <span style="font-weight: bold">= </span>iter<span style="font-weight: bold">(</span>case<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">])
            </span>answers <span style="font-weight: bold">= []
            </span><span style="color: blue; font-weight: bold">for </span>line <span style="color: blue; font-weight: bold">in </span>lines<span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">if </span>len<span style="font-weight: bold">(</span>lines<span style="font-weight: bold">) &gt; </span><span style="color: red">1 </span><span style="color: blue; font-weight: bold">and not </span>line<span style="font-weight: bold">.</span>startswith<span style="font-weight: bold">(</span><span style="color: red">'$'</span><span style="font-weight: bold">):
                    </span><span style="color: blue; font-weight: bold">if </span>line<span style="font-weight: bold">.</span>startswith<span style="font-weight: bold">(</span><span style="color: red">' '</span><span style="font-weight: bold">): </span><span style="color: green; font-style: italic"># indented
                        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>PS2 <span style="font-weight: bold">+ </span>line<span style="font-weight: bold">)
                    </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
                        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>PS1 <span style="font-weight: bold">+ </span>line<span style="font-weight: bold">)
                    </span><span style="color: blue; font-weight: bold">continue
                </span>line <span style="font-weight: bold">= </span>line<span style="font-weight: bold">.</span>replace<span style="font-weight: bold">(</span><span style="color: red">'$ '</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>PS1 <span style="font-weight: bold">+ </span>line<span style="font-weight: bold">)
                </span>answer <span style="font-weight: bold">= </span>handle_student_input<span style="font-weight: bold">(</span>next<span style="font-weight: bold">(</span>outputs<span style="font-weight: bold">), </span>prompt<span style="font-weight: bold">, </span>hash_fn<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">if </span>answer <span style="color: blue; font-weight: bold">is </span><span style="color: blue">None</span><span style="font-weight: bold">:
                    </span><span style="color: blue; font-weight: bold">return
                </span>answers<span style="font-weight: bold">.</span>append<span style="font-weight: bold">(</span>answer<span style="font-weight: bold">)
            </span>case<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">] = </span>answers
            case<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">] += </span><span style="color: red">'unlock'
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"-- Congratulations, you have unlocked this case! --"</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"You are done unlocking tests for this question!"</span><span style="font-weight: bold">)

</span><span style="color: blue; font-weight: bold">def </span>handle_student_input<span style="font-weight: bold">(</span>output<span style="font-weight: bold">, </span>prompt<span style="font-weight: bold">, </span>hash_fn<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Reads student input for unlocking tests.

    PARAMETERS:
    output  -- str or tuple; if str, represents the hashed version of
               the correct output. If tuple, represents a sequence of
               choices (strings) from which the student can choose
    prompt  -- str; the prompt to display when asking for student input
    hash_fn -- function; hash function

    DESCRIPTION:
    Continually prompt the student for an answer to an unlocking
    question until one of the folliwng happens:

        `1. The student supplies the correct answer, in which case
            the supplied answer is returned
         2. The student aborts abnormally (either by typing 'exit()' or
            using Ctrl-C/D. In this case, return None

    Correctness is determined by hashing student input and comparing
    to the parameter "output", which is a hashed version of the correct
    answer. If the hashes are equal, the student answer is assumed to
    be correct.

    RETURNS:
    str  -- the correct solution (that the student supplied)
    None -- indicates an abnormal exit from input prompt
    """
    </span>answer <span style="font-weight: bold">= </span>output
    correct <span style="font-weight: bold">= </span><span style="color: blue; font-weight: bold">False
    while not </span>correct<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span>output<span style="font-weight: bold">) == </span>tuple<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">()
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Choose the number of the correct choice:"</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">for </span>i<span style="font-weight: bold">, </span>choice <span style="color: blue; font-weight: bold">in </span>enumerate<span style="font-weight: bold">(</span>random<span style="font-weight: bold">.</span>sample<span style="font-weight: bold">(</span>output<span style="font-weight: bold">, </span>len<span style="font-weight: bold">(</span>output<span style="font-weight: bold">))):
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'    ' </span><span style="font-weight: bold">+ </span>str<span style="font-weight: bold">(</span>i<span style="font-weight: bold">) + </span><span style="color: red">') ' </span><span style="font-weight: bold">+ </span>split<span style="font-weight: bold">(</span>choice<span style="font-weight: bold">, </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n       '</span><span style="font-weight: bold">))
                </span><span style="color: blue; font-weight: bold">if </span>choice <span style="font-weight: bold">== </span>output<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">]:
                    </span>answer <span style="font-weight: bold">= </span>hash_fn<span style="font-weight: bold">(</span>str<span style="font-weight: bold">(</span>i<span style="font-weight: bold">))
        </span>sys<span style="font-weight: bold">.</span>stdout <span style="font-weight: bold">= </span>sys<span style="font-weight: bold">.</span>__stdout__
        <span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span>student_input <span style="font-weight: bold">= </span>input<span style="font-weight: bold">(</span>prompt <span style="font-weight: bold">+ </span><span style="color: red">' '</span><span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">except </span><span style="font-weight: bold">(</span>KeyboardInterrupt<span style="font-weight: bold">, </span>EOFError<span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'\nExiting unlocker...'</span><span style="font-weight: bold">)
            </span><span style="color: green; font-style: italic"># When you use Ctrl+C in Windows, it throws
            # two exceptions, so you need to catch both of
            # them.... aka Windows is terrible.
            </span><span style="color: blue; font-weight: bold">except </span><span style="font-weight: bold">(</span>KeyboardInterrupt<span style="font-weight: bold">, </span>EOFError<span style="font-weight: bold">):
                </span><span style="color: blue; font-weight: bold">pass
            return
        finally</span><span style="font-weight: bold">:
            </span>sys<span style="font-weight: bold">.</span>stdout <span style="font-weight: bold">= </span>logger
        <span style="color: blue; font-weight: bold">if </span>student_input <span style="color: blue; font-weight: bold">in </span><span style="font-weight: bold">(</span><span style="color: red">'exit()'</span><span style="font-weight: bold">, </span><span style="color: red">'quit()'</span><span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'\nExiting unlocker...'</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return
        </span>correct <span style="font-weight: bold">= </span>hash_fn<span style="font-weight: bold">(</span>student_input<span style="font-weight: bold">) == </span>answer
        <span style="color: blue; font-weight: bold">if not </span>correct<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"-- Not quite. Try again! --"</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>type<span style="font-weight: bold">(</span>output<span style="font-weight: bold">) == </span>tuple<span style="font-weight: bold">:
        </span>student_input <span style="font-weight: bold">= </span>output<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">]
    </span><span style="color: blue; font-weight: bold">return </span>student_input

<span style="color: green; font-style: italic">#########################
# AUTO-UPDATE MECHANISM #
#########################

</span><span style="color: blue; font-weight: bold">def </span>check_for_updates<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Checks a remote url for changes to the project tests, and
    applies changes depending on user input.

    PARAMETERS:
    tests    -- dict; contents of tests.pkl
    filepath -- str; remote or local filepath to check

    RETURNS:
    bool; True if new changes were made, False if no changes made or
    error occurred.
    """
    </span>version <span style="font-weight: bold">= </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'version'</span><span style="font-weight: bold">]
    </span><span style="color: blue; font-weight: bold">if </span>filepath <span style="color: blue; font-weight: bold">is </span><span style="color: blue">None</span><span style="font-weight: bold">:
        </span>filepath <span style="font-weight: bold">= </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'remote'</span><span style="font-weight: bold">]
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'You are running version'</span><span style="font-weight: bold">, </span>version<span style="font-weight: bold">, </span><span style="color: red">'of the autograder'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Changelog url:'</span><span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">)

    </span>filepath <span style="font-weight: bold">= </span>os<span style="font-weight: bold">.</span>path<span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>filepath<span style="font-weight: bold">, </span><span style="color: red">'CHANGES'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>os<span style="font-weight: bold">.</span>path<span style="font-weight: bold">.</span>exists<span style="font-weight: bold">(</span>filepath<span style="font-weight: bold">):
        </span>f <span style="font-weight: bold">= </span><span style="color: blue">None
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span>f <span style="font-weight: bold">= </span>open<span style="font-weight: bold">(</span>filepath<span style="font-weight: bold">, </span><span style="color: red">'r'</span><span style="font-weight: bold">)
            </span>changelog <span style="font-weight: bold">= </span>f<span style="font-weight: bold">.</span>read<span style="font-weight: bold">()
        </span><span style="color: blue; font-weight: bold">except </span>IOError as e<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Problems reading changelog from"</span><span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>e<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return False
        finally</span><span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">if </span>f <span style="color: blue; font-weight: bold">is not </span><span style="color: blue">None</span><span style="font-weight: bold">:
                </span>f<span style="font-weight: bold">.</span>close<span style="font-weight: bold">()
    </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span>data <span style="font-weight: bold">= </span>timed<span style="font-weight: bold">(</span>urllib<span style="font-weight: bold">.</span>request<span style="font-weight: bold">.</span>urlopen<span style="font-weight: bold">, (</span>filepath<span style="font-weight: bold">,), </span>timeout<span style="font-weight: bold">=</span><span style="color: red">2</span><span style="font-weight: bold">)
            </span>changelog <span style="font-weight: bold">= </span>data<span style="font-weight: bold">.</span>read<span style="font-weight: bold">().</span>decode<span style="font-weight: bold">(</span><span style="color: red">'utf-8'</span><span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">except </span><span style="font-weight: bold">(</span>urllib<span style="font-weight: bold">.</span>error<span style="font-weight: bold">.</span>URLError<span style="font-weight: bold">, </span>urllib<span style="font-weight: bold">.</span>error<span style="font-weight: bold">.</span>HTTPError<span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Couldn't check remote autograder at"</span><span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return False
        except </span>TimeoutError<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Checking for updates timed out."</span><span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return False
        except </span>ValueError<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"No remote or local filepath:"</span><span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return False
    </span>match <span style="font-weight: bold">= </span>re<span style="font-weight: bold">.</span>match<span style="font-weight: bold">(</span><span style="color: red">'VERSION ([0-9.]+)'</span><span style="font-weight: bold">, </span>changelog<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>match <span style="color: blue; font-weight: bold">and </span>match<span style="font-weight: bold">.</span>group<span style="font-weight: bold">(</span><span style="color: red">1</span><span style="font-weight: bold">) != </span>version<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Version'</span><span style="font-weight: bold">, </span>match<span style="font-weight: bold">.</span>group<span style="font-weight: bold">(</span><span style="color: red">1</span><span style="font-weight: bold">), </span><span style="color: red">'is available.'</span><span style="font-weight: bold">)
        </span>prompt <span style="font-weight: bold">= </span>input<span style="font-weight: bold">(</span><span style="color: red">'Do you want to automatically download changes? [y/n]: '</span><span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'y' </span><span style="color: blue; font-weight: bold">in </span>prompt<span style="font-weight: bold">.</span>lower<span style="font-weight: bold">():
            </span>success <span style="font-weight: bold">= </span>parse_changelog<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">, </span>changelog<span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return </span>success
        <span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Changes not made.'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">return False

def </span>parse_changelog<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">, </span>changelog<span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Parses a changelog and updates the tests with the specified
    changes.

    PARAMTERS:
    tests     -- dict; contents tests.pkl
    changelog -- str
    filepath  -- str; filepath of remote files

    RETURNS:
    bool; True if updates successful
    """
    </span>current_version <span style="font-weight: bold">= </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'version'</span><span style="font-weight: bold">]
    </span>parts <span style="font-weight: bold">= </span>changelog<span style="font-weight: bold">.</span>partition<span style="font-weight: bold">(</span><span style="color: red">'VERSION ' </span><span style="font-weight: bold">+ </span>current_version<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>len<span style="font-weight: bold">(</span>parts<span style="font-weight: bold">) == </span><span style="color: red">3</span><span style="font-weight: bold">:     </span><span style="color: green; font-style: italic"># If Version found
        </span>changelog <span style="font-weight: bold">= </span>parts<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">]
    </span>changes <span style="font-weight: bold">= </span>re<span style="font-weight: bold">.</span>split<span style="font-weight: bold">(</span><span style="color: red">'VERSION ([0-9.]+)'</span><span style="font-weight: bold">, </span>changelog<span style="font-weight: bold">)
    </span>changes <span style="font-weight: bold">= </span>list<span style="font-weight: bold">(</span>reversed<span style="font-weight: bold">(</span>changes<span style="font-weight: bold">)) </span><span style="color: green; font-style: italic"># most recent changes last
    </span>changes<span style="font-weight: bold">.</span>pop<span style="font-weight: bold">() </span><span style="color: green; font-style: italic"># split will find empty string before first version
    </span><span style="color: blue; font-weight: bold">assert </span>len<span style="font-weight: bold">(</span>changes<span style="font-weight: bold">) % </span><span style="color: red">2 </span><span style="font-weight: bold">== </span><span style="color: red">0
    </span>num_changes <span style="font-weight: bold">= </span>len<span style="font-weight: bold">(</span>changes<span style="font-weight: bold">) // </span><span style="color: red">2
    </span><span style="color: blue; font-weight: bold">for </span>i <span style="color: blue; font-weight: bold">in </span>range<span style="font-weight: bold">(</span>num_changes<span style="font-weight: bold">):
        </span>version <span style="font-weight: bold">= </span>changes<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">*</span>i<span style="font-weight: bold">+</span><span style="color: red">1</span><span style="font-weight: bold">]
        </span>change_header<span style="font-weight: bold">, </span>change_contents <span style="font-weight: bold">= </span><span style="color: red">''</span><span style="font-weight: bold">, </span><span style="color: red">''
        </span><span style="color: blue; font-weight: bold">for </span>line <span style="color: blue; font-weight: bold">in </span>changes<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">*</span>i<span style="font-weight: bold">].</span>strip<span style="font-weight: bold">(</span><span style="color: red">'\n'</span><span style="font-weight: bold">).</span>split<span style="font-weight: bold">(</span><span style="color: red">'\n'</span><span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">if </span>line<span style="font-weight: bold">.</span>startswith<span style="font-weight: bold">(</span><span style="color: red">'    '</span><span style="font-weight: bold">) </span><span style="color: blue; font-weight: bold">or </span>line <span style="font-weight: bold">== </span><span style="color: red">''</span><span style="font-weight: bold">:
                </span>change_contents <span style="font-weight: bold">+= </span>line<span style="font-weight: bold">[</span><span style="color: red">4</span><span style="font-weight: bold">:] + </span><span style="color: red">'\n'
                </span><span style="color: blue; font-weight: bold">continue
            if </span>change_header <span style="font-weight: bold">!= </span><span style="color: red">''</span><span style="font-weight: bold">:
                </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
                    </span>apply_change<span style="font-weight: bold">(</span>change_header<span style="font-weight: bold">, </span>change_contents<span style="font-weight: bold">, </span>tests<span style="font-weight: bold">,
                                 </span>filepath<span style="font-weight: bold">)
                </span><span style="color: blue; font-weight: bold">except </span>AssertionError as e<span style="font-weight: bold">:
                    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Update error:"</span><span style="font-weight: bold">, </span>e<span style="font-weight: bold">)
                    </span><span style="color: blue; font-weight: bold">return False
            </span>change_header <span style="font-weight: bold">= </span>line
            change_contents <span style="font-weight: bold">= </span><span style="color: red">''
        </span><span style="color: green; font-style: italic"># Apply last change
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span>terminate <span style="font-weight: bold">= </span>apply_change<span style="font-weight: bold">(</span>change_header<span style="font-weight: bold">, </span>change_contents<span style="font-weight: bold">, </span>tests<span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">except </span>AssertionError as e<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Update error:"</span><span style="font-weight: bold">, </span>e<span style="font-weight: bold">)
            </span><span style="color: blue; font-weight: bold">return False
        if </span>terminate<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">break
            </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'version'</span><span style="font-weight: bold">] = </span>version

    logger<span style="font-weight: bold">.</span>on<span style="font-weight: bold">()
    </span>tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'version'</span><span style="font-weight: bold">] = </span>version
    <span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Updated to VERSION " </span><span style="font-weight: bold">+ </span>version<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>version <span style="font-weight: bold">!= </span>changes<span style="font-weight: bold">[-</span><span style="color: red">1</span><span style="font-weight: bold">]:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Please re-run the autograder to check for further "
              "updates"</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">"Applied changelog:\n"</span><span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span>changelog<span style="font-weight: bold">)
    </span>logger<span style="font-weight: bold">.</span>off<span style="font-weight: bold">()
    </span><span style="color: blue; font-weight: bold">return True

</span>CHANGE <span style="font-weight: bold">= </span><span style="color: red">'CHANGE'
</span>APPEND <span style="font-weight: bold">= </span><span style="color: red">'APPEND'
</span>REMOVE <span style="font-weight: bold">= </span><span style="color: red">'REMOVE'
</span>GRADER <span style="font-weight: bold">= </span><span style="color: red">'GRADER'

</span><span style="color: blue; font-weight: bold">def </span>apply_change<span style="font-weight: bold">(</span>header<span style="font-weight: bold">, </span>contents<span style="font-weight: bold">, </span>tests<span style="font-weight: bold">, </span>filepath<span style="font-weight: bold">):
    </span><span style="color: darkred">"""Subroutine that applies the changes described by the header
    and contents.

    PARAMTERS:
    header   -- str; a line describing the type of change
    contents -- str; contents of change, if applicable
    tests    -- dict; contents of tests.pkl
    filepath -- str; filepath to check remote grader

    RAISES:
    AssertionError; if any invalid changes are attempted.

    RETURNS:
    bool; True if GRADER was updated and 'RESTART' is in the header,
    in which case update should exit immediately
    """
    </span>error_msg <span style="font-weight: bold">= </span><span style="color: red">'invalid change "{}"'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>header<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">if </span>GRADER <span style="color: blue; font-weight: bold">in </span>header<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
            </span>url <span style="font-weight: bold">= </span>os<span style="font-weight: bold">.</span>path<span style="font-weight: bold">.</span>join<span style="font-weight: bold">(</span>filepath<span style="font-weight: bold">, </span><span style="color: red">'autograder.py'</span><span style="font-weight: bold">)
            </span>data <span style="font-weight: bold">= </span>timed<span style="font-weight: bold">(</span>urllib<span style="font-weight: bold">.</span>request<span style="font-weight: bold">.</span>urlopen<span style="font-weight: bold">, (</span>url<span style="font-weight: bold">,), </span>timeout<span style="font-weight: bold">=</span><span style="color: red">2</span><span style="font-weight: bold">)
            </span>new_autograder <span style="font-weight: bold">= </span>data<span style="font-weight: bold">.</span>read<span style="font-weight: bold">().</span>decode<span style="font-weight: bold">(</span><span style="color: red">'utf-8'</span><span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">except </span><span style="font-weight: bold">(</span>urllib<span style="font-weight: bold">.</span>error<span style="font-weight: bold">.</span>URLError<span style="font-weight: bold">, </span>urllib<span style="font-weight: bold">.</span>error<span style="font-weight: bold">.</span>HTTPError<span style="font-weight: bold">):
            </span><span style="color: blue; font-weight: bold">raise </span>AssertionError<span style="font-weight: bold">(</span><span style="color: red">"Couldn't retrive remote update for autograder.py"</span><span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">except </span>TimeoutError<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">raise </span>AssertionError<span style="font-weight: bold">(</span><span style="color: red">"Checking for updates timed out."</span><span style="font-weight: bold">)
        </span>with open<span style="font-weight: bold">(</span><span style="color: red">'autograder.py'</span><span style="font-weight: bold">, </span><span style="color: red">'w'</span><span style="font-weight: bold">) </span>as f<span style="font-weight: bold">:
            </span>f<span style="font-weight: bold">.</span>write<span style="font-weight: bold">(</span>new_autograder<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">return </span><span style="color: red">'RESTART' </span><span style="color: blue; font-weight: bold">in </span>header

    header <span style="font-weight: bold">= </span>header<span style="font-weight: bold">.</span>split<span style="font-weight: bold">(</span><span style="color: red">'::'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">assert </span>len<span style="font-weight: bold">(</span>header<span style="font-weight: bold">) == </span><span style="color: red">3</span><span style="font-weight: bold">, </span>error_msg
    change_type <span style="font-weight: bold">= </span>header<span style="font-weight: bold">[</span><span style="color: red">0</span><span style="font-weight: bold">].</span>strip<span style="font-weight: bold">()
    </span><span style="color: blue; font-weight: bold">if </span><span style="color: red">'test' </span><span style="color: blue; font-weight: bold">in </span>header<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">]:
        </span>test_name <span style="font-weight: bold">= </span>header<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">].</span>replace<span style="font-weight: bold">(</span><span style="color: red">'test'</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">).</span>strip<span style="font-weight: bold">()
        </span>test <span style="font-weight: bold">= </span>get_test<span style="font-weight: bold">(</span>tests<span style="font-weight: bold">[</span><span style="color: red">'tests'</span><span style="font-weight: bold">], </span>test_name<span style="font-weight: bold">)
        </span>target <span style="font-weight: bold">= </span><span style="color: red">"test"
    </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
        </span>target <span style="font-weight: bold">= </span><span style="color: red">"tests['" </span><span style="font-weight: bold">+ </span>header<span style="font-weight: bold">[</span><span style="color: red">1</span><span style="font-weight: bold">].</span>strip<span style="font-weight: bold">() + </span><span style="color: red">"']"
    </span>target <span style="font-weight: bold">+= </span>header<span style="font-weight: bold">[</span><span style="color: red">2</span><span style="font-weight: bold">].</span>strip<span style="font-weight: bold">()

    </span><span style="color: blue; font-weight: bold">assert </span>target <span style="color: blue; font-weight: bold">is not </span><span style="color: blue">None</span><span style="font-weight: bold">, </span><span style="color: red">'Invalid test to update: {}'</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>test_name<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">if </span>change_type <span style="font-weight: bold">== </span>CHANGE<span style="font-weight: bold">:
        </span>update <span style="font-weight: bold">= </span><span style="color: red">"{} = {}"</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>target<span style="font-weight: bold">, </span>contents<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">elif </span>change_type <span style="font-weight: bold">== </span>APPEND<span style="font-weight: bold">:
        </span>update <span style="font-weight: bold">= </span><span style="color: red">"{}.append({})"</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>target<span style="font-weight: bold">, </span>contents<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">elif </span>change_type <span style="font-weight: bold">== </span>REMOVE<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">assert </span>contents <span style="font-weight: bold">== </span><span style="color: red">''</span><span style="font-weight: bold">, </span><span style="color: red">"Tried " </span><span style="font-weight: bold">+ </span>REMOVE <span style="font-weight: bold">+ </span><span style="color: red">" with nonempty contents: " </span><span style="font-weight: bold">+ </span>contents
        update <span style="font-weight: bold">= </span><span style="color: red">"del {}"</span><span style="font-weight: bold">.</span>format<span style="font-weight: bold">(</span>target<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">raise </span>AssertionError<span style="font-weight: bold">(</span>error_msg<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">try</span><span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span>update<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">except </span>Exception as e<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">raise </span>AssertionError<span style="font-weight: bold">(</span>e<span style="font-weight: bold">.</span>__class__<span style="font-weight: bold">.</span>__name__ <span style="font-weight: bold">+ </span><span style="color: red">": " </span><span style="font-weight: bold">+ </span>str<span style="font-weight: bold">(</span>e<span style="font-weight: bold">) + </span><span style="color: red">": " </span><span style="font-weight: bold">+ </span>update<span style="font-weight: bold">)

</span><span style="color: green; font-style: italic">##########################
# COMMAND-LINE INTERFACE #
##########################

</span><span style="color: blue; font-weight: bold">def </span>run_all_tests<span style="font-weight: bold">():
    </span><span style="color: darkred">"""Runs a command line interface for the autograder."""
    </span>parser <span style="font-weight: bold">= </span>argparse<span style="font-weight: bold">.</span>ArgumentParser<span style="font-weight: bold">(</span>description<span style="font-weight: bold">=</span><span style="color: red">'CS61A autograder'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-u'</span><span style="font-weight: bold">, </span><span style="color: red">'--unlock'</span><span style="font-weight: bold">, </span>type<span style="font-weight: bold">=</span>str<span style="font-weight: bold">, 
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Unlocks the specified question'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-q'</span><span style="font-weight: bold">, </span><span style="color: red">'--question'</span><span style="font-weight: bold">, </span>type<span style="font-weight: bold">=</span>str<span style="font-weight: bold">,
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Run tests for the specified question'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-v'</span><span style="font-weight: bold">, </span><span style="color: red">'--verbose'</span><span style="font-weight: bold">, </span>action<span style="font-weight: bold">=</span><span style="color: red">'store_true'</span><span style="font-weight: bold">,
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Display tests that passed'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-a'</span><span style="font-weight: bold">, </span><span style="color: red">'--all'</span><span style="font-weight: bold">, </span>action<span style="font-weight: bold">=</span><span style="color: red">'store_true'</span><span style="font-weight: bold">,
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Runs all tests, regardless of failures'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-i'</span><span style="font-weight: bold">, </span><span style="color: red">'--interactive'</span><span style="font-weight: bold">, </span>action<span style="font-weight: bold">=</span><span style="color: red">'store_true'</span><span style="font-weight: bold">,
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Enables interactive mode upon failure'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-t'</span><span style="font-weight: bold">, </span><span style="color: red">'--timeout'</span><span style="font-weight: bold">, </span>type<span style="font-weight: bold">=</span>int<span style="font-weight: bold">,
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Change timeout length'</span><span style="font-weight: bold">)
    </span>parser<span style="font-weight: bold">.</span>add_argument<span style="font-weight: bold">(</span><span style="color: red">'-r'</span><span style="font-weight: bold">, </span><span style="color: red">'--remote'</span><span style="font-weight: bold">, </span>type<span style="font-weight: bold">=</span>str<span style="font-weight: bold">, </span>default<span style="font-weight: bold">=</span><span style="color: blue">None</span><span style="font-weight: bold">,
                        </span>help<span style="font-weight: bold">=</span><span style="color: red">'Check given filepath or url for updates'</span><span style="font-weight: bold">)
    </span>args <span style="font-weight: bold">= </span>parser<span style="font-weight: bold">.</span>parse_args<span style="font-weight: bold">()

    </span>with open<span style="font-weight: bold">(</span><span style="color: red">'tests.pkl'</span><span style="font-weight: bold">, </span><span style="color: red">'rb'</span><span style="font-weight: bold">) </span>as f<span style="font-weight: bold">:
        </span>all_tests <span style="font-weight: bold">= </span>pickle<span style="font-weight: bold">.</span>load<span style="font-weight: bold">(</span>f<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">if </span>check_for_updates<span style="font-weight: bold">(</span>all_tests<span style="font-weight: bold">, </span>args<span style="font-weight: bold">.</span>remote<span style="font-weight: bold">):
        </span>with open<span style="font-weight: bold">(</span><span style="color: red">'tests.pkl'</span><span style="font-weight: bold">, </span><span style="color: red">'wb'</span><span style="font-weight: bold">) </span>as f<span style="font-weight: bold">:
            </span>pickle<span style="font-weight: bold">.</span>dump<span style="font-weight: bold">(</span>all_tests<span style="font-weight: bold">, </span>f<span style="font-weight: bold">, </span>pickle<span style="font-weight: bold">.</span>DEFAULT_PROTOCOL<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">return
    print</span><span style="font-weight: bold">()

    </span><span style="color: blue; font-weight: bold">if </span>args<span style="font-weight: bold">.</span>unlock<span style="font-weight: bold">:
        </span>unlock<span style="font-weight: bold">(</span>args<span style="font-weight: bold">.</span>unlock<span style="font-weight: bold">, </span>all_tests<span style="font-weight: bold">)
        </span>with open<span style="font-weight: bold">(</span><span style="color: red">'tests.pkl'</span><span style="font-weight: bold">, </span><span style="color: red">'wb'</span><span style="font-weight: bold">) </span>as f<span style="font-weight: bold">:
            </span>pickle<span style="font-weight: bold">.</span>dump<span style="font-weight: bold">(</span>all_tests<span style="font-weight: bold">, </span>f<span style="font-weight: bold">, </span>pickle<span style="font-weight: bold">.</span>DEFAULT_PROTOCOL<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">return

    if </span>args<span style="font-weight: bold">.</span>question<span style="font-weight: bold">:
        </span>tests <span style="font-weight: bold">= </span>get_test<span style="font-weight: bold">(</span>all_tests<span style="font-weight: bold">[</span><span style="color: red">'tests'</span><span style="font-weight: bold">], </span>args<span style="font-weight: bold">.</span>question<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">if not </span>tests<span style="font-weight: bold">:
            </span>exit<span style="font-weight: bold">(</span><span style="color: red">1</span><span style="font-weight: bold">)
        </span>tests <span style="font-weight: bold">= [</span>tests<span style="font-weight: bold">]
    </span><span style="color: blue; font-weight: bold">else</span><span style="font-weight: bold">:
        </span>tests <span style="font-weight: bold">= </span>all_tests<span style="font-weight: bold">[</span><span style="color: red">'tests'</span><span style="font-weight: bold">]

    </span><span style="color: blue; font-weight: bold">if </span>args<span style="font-weight: bold">.</span>timeout<span style="font-weight: bold">:
        </span><span style="color: blue; font-weight: bold">global </span>TIMEOUT
        TIMEOUT <span style="font-weight: bold">= </span>args<span style="font-weight: bold">.</span>timeout

    global_frame <span style="font-weight: bold">= {}
    </span><span style="color: blue; font-weight: bold">for </span>line <span style="color: blue; font-weight: bold">in </span>all_tests<span style="font-weight: bold">[</span><span style="color: red">'project_info'</span><span style="font-weight: bold">][</span><span style="color: red">'imports'</span><span style="font-weight: bold">]:
        </span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span>line<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">exec</span><span style="font-weight: bold">(</span>split<span style="font-weight: bold">(</span>all_tests<span style="font-weight: bold">.</span>get<span style="font-weight: bold">(</span><span style="color: red">'cache'</span><span style="font-weight: bold">, </span><span style="color: red">''</span><span style="font-weight: bold">), </span>join_str<span style="font-weight: bold">=</span><span style="color: red">'\n'</span><span style="font-weight: bold">),
         </span>global_frame<span style="font-weight: bold">)

    </span><span style="color: blue; font-weight: bold">for </span>test <span style="color: blue; font-weight: bold">in </span>tests<span style="font-weight: bold">:
        </span>passed <span style="font-weight: bold">= </span>run<span style="font-weight: bold">(</span>test<span style="font-weight: bold">, </span>global_frame<span style="font-weight: bold">, </span>args<span style="font-weight: bold">.</span>interactive<span style="font-weight: bold">,
                     </span>all_tests<span style="font-weight: bold">[</span><span style="color: red">'preamble'</span><span style="font-weight: bold">], </span>args<span style="font-weight: bold">.</span>verbose<span style="font-weight: bold">)
        </span><span style="color: blue; font-weight: bold">if not </span>args<span style="font-weight: bold">.</span>all <span style="color: blue; font-weight: bold">and not </span>passed<span style="font-weight: bold">:
            </span><span style="color: blue; font-weight: bold">return
    </span>underline<span style="font-weight: bold">(</span><span style="color: red">'Note:'</span><span style="font-weight: bold">, </span>under<span style="font-weight: bold">=</span><span style="color: red">'-'</span><span style="font-weight: bold">)
    </span><span style="color: blue; font-weight: bold">print</span><span style="font-weight: bold">(</span><span style="color: red">'Remember that the tests in this autograder are not'</span><span style="font-weight: bold">,
          </span><span style="color: red">'exhaustive, so try your own tests in the interpreter!'</span><span style="font-weight: bold">)

</span><span style="color: blue; font-weight: bold">if </span>__name__ <span style="font-weight: bold">== </span><span style="color: red">'__main__'</span><span style="font-weight: bold">:
    </span>run_all_tests<span style="font-weight: bold">()
</span>
</pre>
</body>
</html>